(function(){function n(a){this.instance=new createjs.Shape}function r(){this.bullet=function(){n.apply(this,arguments)};d.extend(this.bullet.prototype,n.prototype);this.bullet.prototype.pool=this;this.pool=[]}function s(){var a=this.input_state={};this.new_input_state={};this.pressed={};this.released={};var b=this.keyboard_mapping={},c;for(c in m.key_mapping.keyboard)a[c]=0,m.key_mapping.keyboard[c].forEach(function(a){b[a]={name:c,count:0}});var k=this.gamepad_mapping=[];for(c in m.key_mapping.gamepad)a[c]=
0,m.key_mapping.gamepad[c].forEach(function(a){k.push({key:a,name:c,count:0})});var e=this;document.getElementById("game-container").addEventListener("keydown",function(a){var b=e.keyboard_mapping[a.keyCode];b&&(a.preventDefault(),0==b.count&&(b.count=1,e.pressed[b.name]=1,e.input_state[b.name]=1))});document.getElementById("game-container").addEventListener("keyup",function(a){var b=e.keyboard_mapping[a.keyCode];b&&(a.preventDefault(),1==b.count&&(b.count=0,e.released[b.name]=1,e.input_state[b.name]=
0))})}function l(){}function t(a){this.ms=a}function u(a){this.key_name=a}function v(a,b){this.update=function(c){return a.call(b,c)}}function w(a){this.msg_list=a;this.char_idx=this.msg_idx=0}function p(a){this.script=a?a.slice(0):[];this.script.push(f.halt);this.pre_process();this.restart()}function x(a,b){this.cur_entry={op:a};this.stage=b}function y(){var a=this.message_area=new createjs.Text("FPS: 0");a.x=50;a.y=50;a.color="yellow";a.font="13px Georgia";this.message=""}function z(){function a(a){d.extend(this,
a);this.bullets=[];this.bullets2=[];this.bullet_layer=new createjs.Container;this.bullet_pool=new r;this.update_instance();var b=this;this.instance.addEventListener("animationend",function(a){"release"==a.name&&(b.releasing=!1)})}function b(a){if(c.enemy_found)return a.id==c.enemy.id;if(a.id==c.player.id)return!1;c.enemy_found=!0;c.enemy.id=a.id;return!0}a.prototype={shoot_interval:50,shoot_angular_speed:Math.PI/1E3,shoot_count:3,shoot_timer:0,shoot_direction:0,move_speed:0.2,move_speed_focus:0.1,
bullet_speed:0.128,bullet_min_radius:5,bullet_max_radius:20,bullet_lightness:50,bullet_alpha:0.9,radius:5,stage_margin:100,hp:100,focused:!1,releasing:!1,update_bullets:function(a){var b=this.bullets2;b.length=0;for(var c=this.stage_margin,h=0,g=this.bullets.length;h<g;++h){var d=this.bullets[h];d.update_physics(a);d.update_graphics();d.x<-c||d.x>WLGame.stage.canvas.width+c||d.y<-c||d.y>WLGame.stage.canvas.height+c?(d.off_stage(),d.recycle()):b.push(d)}this.bullets2=this.bullets;this.bullets=b},focus:function(){this.focused||
this.releasing||(this.focused=!0,this.instance.gotoAndPlay("focus"))},release:function(){this.focused&&(this.focused=!1,this.releasing=!0,this.instance.gotoAndPlay("release"))},shoot:function(a){for(this.shoot_timer+=a;this.shoot_timer>this.shoot_interval;){this.shoot_timer-=this.shoot_interval;a=this.shoot_direction;for(var b=0;b<this.shoot_count;++b){var c=this.bullet_pool.get(),h=this.bullet_min_radius+Math.random()*(this.bullet_max_radius-this.bullet_min_radius);c.instance.graphics.c().ss(2).s("white").f(createjs.Graphics.getHSL(Date.now()%
2E3/2E3*360,100,this.bullet_lightness)).dc(0,0,h-1);c.instance.cache(-h-1,-h-1,2*h+2,2*h+2);c.instance.alpha=this.bullet_alpha;Math.sqrt(2);var g=this.bullet_speed*(1+(1+Math.cos(Date.now()%2E3))/2);d.extend(c,{x:this.x,y:this.y,vx:g*Math.cos(a),vy:g*Math.sin(a),radius:h});c.on_stage(this.bullet_layer);this.bullets.push(c);a+=2*Math.PI/this.shoot_count}}},update_instance:function(a){this.instance.x=Math.round(this.x);this.instance.y=Math.round(this.y)},update:function(a){this.update_bullets(a);this.update_instance(a)}};
this.player=new a({x:WLGame.stage_width/2,y:0.9*WLGame.stage_height,shoot_direction:0,dir:0,id:Math.random(),instance:new createjs.Sprite(new createjs.SpriteSheet({framerate:12,images:[WLGame.assets.getResult("reimu")],frames:[[115,0,46,96,0,25,44],[0,0,61,96,0,30,44],[0,96,61,96,0,33,44],[61,96,46,112,0,25,60],[107,96,48,99,0,24,47],[61,0,54,96,0,26,44],[155,96,46,96,0,25,44]],animations:{idle:[1],focus:[0],release:[1,6,"idle"]}}),"idle"),bullet_lightness:25,bullet_alpha:0.45});this.enemy=new a({x:WLGame.stage_width/
2,y:0.1*WLGame.stage_height,shoot_direction:Math.PI,id:0,instance:new createjs.Sprite(new createjs.SpriteSheet({framerate:12,images:[WLGame.assets.getResult("marisa")],frames:[[172,0,62,101,0,27.95,50],[103,303,90,101,0,29.95,50],[150,202,90,101,0,31.95,50],[154,101,70,101,0,21.95,50],[0,0,172,101,0,26.95,50],[0,101,154,101,0,15.95,50],[0,202,150,101,0,19.95,50],[0,303,103,101,0,18.95,50]],animations:{idle:[0],focus:[1,2,!1],release:[3,7,"idle"]}}),"idle")});this.enemy.instance.visible=!1;this.bg_img=
new createjs.Bitmap(WLGame.assets.getResult("bg"));this.sync_event_buffer=[];this.shoot_timer=this.shoot_interval+1;this.message_board=new createjs.Text;this.message_board.font="100px Georgia";this.message_board.alpha=0;this.message_board.visible=!1;this.message_board.color="white";this.round_started=this.enemy_found=!1;var c=this;this.handle_ping=function(a){a.sameUrl&&b(a)&&TogetherJS.send({type:"pong",id:c.player.id})};this.handle_pong=function(a){a.sameUrl&&b(a)&&c.send_ping_id&&(clearInterval(c.send_ping_id),
c.send_ping_id=null)};this.handle_ready=function(a,e){if((e||a.sameUrl)&&(e||b(a))&&!c.round_started)if(-1==a.count)c.start_fight();else{var d=c.message_board;d.text=0==a.count?"Fight!":a.count;d.alpha=1;d.visible=!0;var h=d.getBounds();d.x=WLGame.stage_width/2-h.width/2;d.y=WLGame.stage_height/2-h.height/2;createjs.Tween.get(d,{override:!0}).to({alpha:0,visible:!1},500)}};this.handle_sync=function(a){a.sameUrl&&b(a)&&a.id!=c.player.id&&c.sync_event_buffer.push(a)};TogetherJS.hub.on("ping",this.handle_ping);
TogetherJS.hub.on("pong",this.handle_pong);TogetherJS.hub.on("ready",this.handle_ready);TogetherJS.hub.on("sync",this.handle_sync);p.call(this,[-3,function(a){return window.TJS.ready?a:0},function(a){this.send_ping_id=setInterval(function(){TogetherJS.send({type:"ping",id:c.player.id})},3E3);return a},function(a){if(this.enemy_found){console.log("paired with",this.enemy.id);var b=this.enemy.instance;b.alpha=0;b.visible=!0;createjs.Tween.get(b).to({alpha:1},1E3);return a}return 0},function(a){if(this.player.id>
this.enemy.id){var b=3,c=this,d=function(){var a={type:"ready",count:b,id:c.player.id};TogetherJS.send(a);c.handle_ready(a,!0);--b;-1<=b&&setTimeout(d,1E3)};setTimeout(d,1E3)}return a},this.battle_mainloop,function(a){},f.halt])}function q(a){this.assets=a}var m={key_mapping:{keyboard:{move_left:[KeyEvent.DOM_VK_LEFT],move_right:[KeyEvent.DOM_VK_RIGHT],move_up:[KeyEvent.DOM_VK_UP],move_down:[KeyEvent.DOM_VK_DOWN],action:[KeyEvent.DOM_VK_SHIFT]},gamepad:{move_left:[[0,-0.5],14],move_right:[[0,0.5],
15],move_up:[[1,-0.5],12],move_down:[[1,0.5],13],action:[0,2]}}},d={extend:function(){if(0==arguments.length)return{};for(var a=arguments[0],b=0,c=arguments.length;b<c;++b){var d=arguments[b],e;for(e in d)a[e]=d[e]}return a},range:function(a,b,c){return a<b?b:a>c?c:a},error:function(a){console.error(a);createjs.Ticker.setPaused(!0);throw a;},get_cached_obj:function(a){a=new a;var b=a.nominalBounds;a.cache(b.x,b.y,b.width,b.height);return a},get_bbox_of_dom_obj:function(a){a=a.getBoundingClientRect();
var b=WLGame.game_container.getBoundingClientRect();return{x:a.left-b.left,y:a.top-b.top,width:a.width,height:a.height}}};d.extend(n.prototype,{instance:null,x:0,y:0,vx:0,vy:0,hb_hw:0,hb_hh:0,colliding_mask:0,colliding_group:0,on_stage:function(a){a.addChild(this.instance)},off_stage:function(){var a=this.instance;a.parent&&a.parent.removeChild(a)},recycle:function(){this.pool.put(this)},get_hitbox:function(){return{x:this.x,y:this.y,hw:this.hb_hw,hh:this.hb_hh}},update_physics:function(a){this.x+=
this.vx*a;this.y+=this.vy*a},update_graphics:function(){this.instance.x=Math.round(this.x);this.instance.y=Math.round(this.y)}});d.extend(r.prototype,{put:function(a){this.pool.push(a)},get:function(){return 0<this.pool.length?this.pool.pop():new this.bullet}});d.extend(s.prototype,{gamepad_connected:!0,update:function(a){if(this.gamepad_connected)try{var b=navigator.webkitGetGamepads()[0],c=this;this.gamepad_mapping.forEach(function(a){var d=a.key,h=a.name,g=0;"number"===typeof d?g=b.buttons[d]:
(g=d[1],d=b.axes[d[0]],g=0>g&&d<g||0<g&&d>g?1:0);a.count!=g&&(a.count=g,1==g?c.pressed[h]=1:c.released[h]=1,c.input_state[h]=g)})}catch(d){}},next_frame:function(){for(var a in this.pressed)this.pressed[a]=0;for(a in this.released)this.released[a]=0},is_held:function(a){return 1==this.input_state[a]},is_pressed:function(a){return 1==this.pressed[a]},is_released:function(a){return 1==this.released[a]}});var f={label:1,call:2,goto:3,trap:4,halt:5,msg:6,return:10,restart:11,nop:14,function:16,set_fps:17,
call_op:18,invalid:0};d.extend(l.prototype,{init:function(){},on_stage:function(a){},off_stage:function(a){},update:function(a){return a}});d.extend(t.prototype,new l,{update:function(a){if(a>=this.ms)return a-this.ms;this.ms-=a;return 0}});d.extend(u.prototype,new l,{update:function(a){return WLGame.input.is_released(this.key_name)?a:0}});d.extend(v.prototype,new l);d.extend(w.prototype,new l,{dialog_frame:document.getElementById("game-dialog-frame"),char_interval:64,on_stage:function(a){this.dialog_frame.innerHTML=
"";this.dialog_frame.style.display="block"},off_stage:function(a){this.dialog_frame.style.display="none"},update:function(a){if(this.msg_idx>=this.msg_list.length)return a;var b=this.msg_list[this.msg_idx];if(this.char_idx>b.length)return this.char_idx=0,++this.msg_idx,WLGame.director.call_op(new u("action")),a;this.dialog_frame.innerHTML=b.slice(0,this.char_idx);++this.char_idx;if(WLGame.input.is_held("action2"))return 0;WLGame.director.call_op(new t(this.char_interval));return a}});d.extend(p.prototype,
new l,{inc_op_idx:!0,on_stage:function(a){this.stage=a},restart:function(){this.op_idx=-1;this.stack=[]},update:function(a){var b=this.next_op();b&&WLGame.director.call_op(b);return a},next_op:function(){for(;;){this.inc_op_idx?++this.op_idx:this.inc_op_idx=!0;var a=this.script[this.op_idx];if(!a)return d.error("Invalid op_idx: "+this.op_idx),dt;if(a[0]!=f.function&&a[0]!=f.call_op)for(var b=1,c=a.length;b<c;++b)"function"===typeof a[b]&&(a[b]=a[b].call(this));switch(a[0]){case f.label:break;case f.call:this.call_label(a[1]);
break;case f.goto:this.goto_label(a[1]);break;case f.trap:d.error("trapped "+this.op_idx);break;case f.halt:return null;case f.msg:return new w(a.slice(1));case f.return:this.op_idx=this.stack.pop();this.inc_op_idx=!1;break;case f.restart:this.restart();break;case f.nop:break;case f.function:return new v(a[1],this);case f.set_fps:createjs.Ticker.setFPS(a[1]);break;case f.call_op:return new a[1];default:d.error("Unknown op: "+a)}}},call_label:function(a){this.stack.push(this.op_idx+1);this.goto_label(a)},
goto_label:function(a){a in this.labels?(this.op_idx=this.labels[a],this.inc_op_idx=!1):d.error("Unknown label: "+a)},pre_process:function(){for(var a=this.script,b=0,c=a.length;b<c;++b){var k=a[b];"number"==typeof k?a[b]=0>k?[f.label,k]:[k]:"function"==typeof k&&(a[b]=[f.function,k])}this.labels={};b=0;for(c=a.length;b<c;++b)a[b][0]==f.label&&(k=a[b][1],k in this.labels&&d.error("Duplicated labels: "+k),this.labels[k]=b)}});d.extend(x.prototype,{cur_entry_changed:!1,call_op:function(a){this.cur_entry_changed=
!0;this.cur_entry={op:a,next:this.cur_entry}},update:function(a){try{for(;;){var b=this.cur_entry;if(!b)return d.error("Director done"),a;b.on_stage||(b.op.on_stage(this.stage),b.on_stage=!0);a=b.op.update(a);if(0>=a)return a;this.cur_entry_changed?this.cur_entry_changed=!1:(b.op.off_stage(this.stage),this.cur_entry=b.next)}}catch(c){console.log("Director dump:"),console.log(this.cur_entry),console.log(c.stack),d.error("error")}}});d.extend(y.prototype,{on_stage:function(a){a.addChild(this.message_area)},
update:function(a){this.message_area.text=this.message}});d.extend(z.prototype,new p,{hp_recover_threshold:3E3,hp_recover_ratio:0.01,on_stage:function(a){this.stage=a;a.addChild(this.bg_img);a.addChild(this.player.bullet_layer);a.addChild(this.player.instance);a.addChild(this.enemy.bullet_layer);a.addChild(this.enemy.instance);a.addChild(this.message_board)},off_stage:function(a){a.removeChild(this.bg_img);a.removeChild(this.player.bullet_layer);a.removeChild(this.player.instance);a.removeChild(this.enemy.bullet_layer);
a.removeChild(this.enemy.instance);a.removeChild(this.message_board)},start_fight:function(){console.log("Fight started.");this.round_started=!0;this.round_start_time=Date.now();this.last_sync_time=0;var a=this.message_board;a.alpha=0;createjs.Tween.removeTweens(a)},check_player_hit:function(){var a=this.player,b=this.enemy.bullet_min_radius,c=this.enemy.bullets,d=this.enemy.bullets2;d.length=0;for(var e=!1,f=0,h=c.length;f<h;++f){var g=c[f],l=g.radius,m=l+this.player.radius,n=a.x-g.x,p=a.y-g.y;n*
n+p*p<m*m?(e=l/b,this.player.hp-=e*e,g.off_stage(),g.recycle(),e=!0):d.push(g)}this.enemy.bullets=d;this.enemy.bullets2=c;return e},process_sync_events:function(a){a=this.sync_event_buffer;for(var b=this.enemy,c=0,d=a.length;c<d;++c){var e=a[c];e.sameUrl&&(b.x=WLGame.stage_width-e.x,b.y=WLGame.stage_height-e.y,b.shoot_direction=e.d>Math.PI?e.d-Math.PI:e.d+Math.PI,b.hp=e.hp,this.last_sync_time=Math.max(this.last_sync_time,e.t),e.f&&!b.focus&&(b.focus=!0,b.instance.gotoAndPlay("focus")),!e.f&&b.focus&&
(b.focus=!1,b.instance.gotoAndPlay("release")))}a.length=0},check_local_input:function(a){var b=this.player;for(b.shoot_direction+=b.shoot_angular_speed*a;b.shoot_direction>2*Math.PI;)b.shoot_direction-=2*Math.PI;a*=b.focus?b.move_speed_focus:b.move_speed;b.x>a&&WLGame.input.is_held("move_left")?b.x-=a:b.x<WLGame.stage_width-a&&WLGame.input.is_held("move_right")&&(b.x+=a);b.y>a&&WLGame.input.is_held("move_up")?b.y-=a:b.y<WLGame.stage_height-a&&WLGame.input.is_held("move_down")&&(b.y+=a);this.round_started&&
WLGame.input.is_pressed("action")&&b.focus();this.round_started&&WLGame.input.is_released("action")&&b.release()},battle_mainloop:function(a){this.process_sync_events(a);this.check_local_input(a);this.player.update(a);this.enemy.update(a);this.round_started&&(this.player.shoot(a),this.enemy.shoot(a),this.check_player_hit(),this.last_sync_time+this.hp_recover_threshold<Date.now()-this.round_start_time&&(this.player.hp=Math.min(100,this.player.hp+this.hp_recover_ratio*a)));WLGame.debug_hud.message=
"FPS: "+Math.round(createjs.Ticker.getMeasuredFPS())+"\nBubbles: "+(this.player.bullets.length+this.enemy.bullets.length)+"\nHP: "+this.player.hp+"\nHP2: "+this.enemy.hp;TogetherJS.send({type:"sync",x:Math.round(this.player.x),y:Math.round(this.player.y),d:this.player.shoot_direction,hp:Math.round(this.player.hp),id:this.player.id,f:this.player.focus?1:0,t:Date.now()-this.round_start_time});return 0}});q.prototype.run=function(){console.log("Game starts.");this.game_container=document.getElementById("game-container");
var a=this.stage=new createjs.Stage("game-canvas1");this.stage_width=a.canvas.width;this.stage_height=a.canvas.height;var b=this.input=this.input=new s,c=new createjs.Container;a.addChild(c);var d=this.director=this.director=new x(new z,c),e=this.debug_hud=new y;e.on_stage(a);createjs.Ticker.setFPS(60);createjs.Ticker.addEventListener("tick",function(c){if(!c.paused){var f=c.delta;b.update(f);d.update(f);e.update(f);a.update(c);b.next_frame()}})};window.Game=q;window.Game.prototype.run=q.prototype.run})();
