(function(){function m(a){this.instance=new createjs.Shape}function r(){this.bullet=function(){m.apply(this,arguments)};f.extend(this.bullet.prototype,m.prototype);this.bullet.prototype.pool=this;this.pool=[]}function s(){var a=this.input_state={};this.new_input_state={};this.pressed={};this.released={};var b=this.keyboard_mapping={},e;for(e in k.key_mapping.keyboard)a[e]=0,k.key_mapping.keyboard[e].forEach(function(a){b[a]={name:e,count:0}});var c=this.gamepad_mapping=[];for(e in k.key_mapping.gamepad)a[e]=
0,k.key_mapping.gamepad[e].forEach(function(a){c.push({key:a,name:e,count:0})});var n=this;document.getElementById("game-container").addEventListener("keydown",function(a){var b=n.keyboard_mapping[a.keyCode];b&&(a.preventDefault(),0==b.count&&(b.count=1,n.pressed[b.name]=1,n.input_state[b.name]=1))});document.getElementById("game-container").addEventListener("keyup",function(a){var b=n.keyboard_mapping[a.keyCode];b&&(a.preventDefault(),1==b.count&&(b.count=0,n.released[b.name]=1,n.input_state[b.name]=
0))})}function h(){}function t(a){this.ms=a}function u(a){this.key_name=a}function v(a,b){this.update=function(e){return a.call(b,e)}}function w(a){this.msg_list=a;this.char_idx=this.msg_idx=0}function p(a){this.script=a?a.slice(0):[];this.script.push(d.halt);this.pre_process();this.restart()}function x(a,b){this.cur_entry={op:a};this.stage=b}function y(){var a=this.message_area=new createjs.Text("FPS: 0");a.x=50;a.y=50;a.color="yellow";a.font="13px Georgia";this.message=""}function z(){function a(a){f.extend(this,
a);this.bullets=[];this.focused_bullets=[];this.bullet_layer=new createjs.Container;this.bullet_pool=new r;this.update_instance();var b=this;this.instance.addEventListener("animationend",function(a){"release"==a.name&&(b.releasing=!1)})}function b(a){if(c.enemy_found)return a.id==c.enemy.id;if(a.id==c.player.id)return!1;c.enemy_found=!0;c.enemy.id=a.id;return!0}a.prototype={shoot_interval:50,shoot_angular_speed:Math.PI/1E3,shoot_count:3,shoot_timer:0,shoot_direction:0,move_speed:0.2,move_speed_focused:0.06,
bullet_speed:0.128,bullet_min_radius:5,bullet_max_radius:20,bullet_lightness:50,bullet_alpha:0.9,focused_shoot_interval:100,focused_bullet_radius:5,focused_bullet_angular_speed:Math.PI/1E3,focused_bullet_release_speed:0.2,focused_bullet_count_limit:30,focused_circle_radius:10,radius:5,stage_margin:100,hp:100,focused:!1,releasing:!1,update_bullets:function(a){for(var b=this.stage_margin,e=this.bullets,l=0,c=e.length;l<c;){var g=e[l];g.update_physics(a);g.update_graphics();g.x<-b||g.x>WLGame.stage.canvas.width+
b||g.y<-b||g.y>WLGame.stage.canvas.height+b?(g.off_stage(),g.recycle(),e[l]=e[c-1],--e.length,--c):++l}for(var b=this.focused_bullets,e=this.focused_bullet_angular_speed,f=this.focused_circle_radius,l=0,c=b.length;l<c;++l){g=b[l];g.life_time+=a;g.revolution_angle+=e*a;var d=Math.log(1+g.life_time)*f;if(isNaN(d))throw console.log(g),"nan";g.x=this.x+d*Math.cos(g.revolution_angle);g.y=this.y+d*Math.sin(g.revolution_angle);g.update_graphics()}},focus:function(){return this.focused||this.releasing?!1:
(this.focused=!0,this.instance.gotoAndPlay("focus"),!0)},release:function(){if(this.focused){this.focused=!1;this.releasing=!0;this.instance.gotoAndPlay("release");for(var a=this.focused_bullets,b=this.focused_bullet_release_speed*(1+(1+Math.cos(Date.now()%2E3))/2),e=this.opponent.x,c=this.opponent.y,f=0,g=a.length;f<g;++f){var d=a[f],h=e-d.x,k=c-d.y,m=Math.sqrt(h*h+k*k);Math.abs(m)<A.EPS?(h=Math.random()*Math.PI*2,d.vx=b*Math.cos(h),d.vy=b*Math.sin(h)):(d.vx=b*h/m,d.vy=b*k/m);this.bullets.push(d)}a.length=
0;return!0}return!1},shoot:function(a){this.shoot_timer+=a;if(this.focused)for(;this.shoot_timer>this.focused_shoot_interval;){if(this.focused_bullets.length>=this.focused_bullet_count_limit){this.shoot_timer=0;break}this.shoot_timer-=this.focused_shoot_interval;var b=this.focused_bullet_radius;Date.now();a=this.shoot_direction;for(var e=0;e<this.shoot_count;++e){var c=this.bullet_pool.get();f.extend(c,{x:this.x,y:this.y,life_time:0,radius:b,revolution_angle:a});c.instance.graphics.c().f(createjs.Graphics.getRGB(0,
255,255,0.2)).de(-2*b-1,-b-1,4*b+2,2*b+2).f("cyan").de(-2*b,-b,4*b,2*b).f("white").de(-2*b+1,-b+1,4*b-2,2*b-2);c.instance.cache(-2*b-1,-b-1,4*b+2,2*b+2);c.instance.rotation=360*Math.random();c.on_stage(this.bullet_layer);this.focused_bullets.push(c);a+=2*Math.PI/this.shoot_count}}else for(;this.shoot_timer>this.shoot_interval;)for(this.shoot_timer-=this.shoot_interval,a=this.shoot_direction,e=0;e<this.shoot_count;++e){c=this.bullet_pool.get();b=this.bullet_min_radius+Math.random()*(this.bullet_max_radius-
this.bullet_min_radius);c.instance.graphics.c().ss(2).s("white").f(createjs.Graphics.getHSL(Date.now()%2E3/2E3*360,100,this.bullet_lightness)).dc(0,0,b-1);c.instance.cache(-b-1,-b-1,2*b+2,2*b+2);c.instance.alpha=this.bullet_alpha;Math.sqrt(2);var d=this.bullet_speed*(1+(1+Math.cos(Date.now()%2E3))/2);f.extend(c,{x:this.x,y:this.y,vx:d*Math.cos(a),vy:d*Math.sin(a),radius:b});c.on_stage(this.bullet_layer);this.bullets.push(c);a+=2*Math.PI/this.shoot_count}},update_instance:function(a){this.instance.x=
Math.round(this.x);this.instance.y=Math.round(this.y)},update:function(a){this.update_bullets(a);this.update_instance(a)}};this.player=new a({x:WLGame.stage_width/2,y:0.9*WLGame.stage_height,shoot_direction:0,dir:0,id:Math.random(),instance:new createjs.Sprite(new createjs.SpriteSheet({framerate:12,images:[WLGame.assets.getResult("reimu")],frames:[[115,0,46,96,0,25,44],[0,0,61,96,0,30,44],[0,96,61,96,0,33,44],[61,96,46,112,0,25,60],[107,96,48,99,0,24,47],[61,0,54,96,0,26,44],[155,96,46,96,0,25,44]],
animations:{idle:[1],focus:[0],release:[1,6,"idle"]}}),"idle"),bullet_lightness:25,bullet_alpha:0.45});this.enemy=new a({x:WLGame.stage_width/2,y:0.1*WLGame.stage_height,shoot_direction:Math.PI,id:0,instance:new createjs.Sprite(new createjs.SpriteSheet({framerate:12,images:[WLGame.assets.getResult("marisa")],frames:[[172,0,62,101,0,27.95,50],[103,303,90,101,0,29.95,50],[150,202,90,101,0,31.95,50],[154,101,70,101,0,21.95,50],[0,0,172,101,0,26.95,50],[0,101,154,101,0,15.95,50],[0,202,150,101,0,19.95,
50],[0,303,103,101,0,18.95,50]],animations:{idle:[0],focus:[1,2,!1],release:[3,7,"idle"]}}),"idle")});this.enemy.instance.visible=!1;this.player.opponent=this.enemy;this.enemy.opponent=this.player;var e=this.player_hit_disc=new createjs.Shape;e.graphics.f("white").dc(0,0,this.player.radius);e.visible=!1;this.bg_img=new createjs.Bitmap(WLGame.assets.getResult("bg"));this.sync_event_buffer=[];this.shoot_timer=this.shoot_interval+1;this.message_board=new createjs.Text;this.message_board.font="100px Georgia";
this.message_board.alpha=0;this.message_board.visible=!1;this.message_board.color="white";this.round_started=this.enemy_found=!1;var c=this;this.handle_ping=function(a){a.sameUrl&&b(a)&&TogetherJS.send({type:"pong",id:c.player.id})};this.handle_pong=function(a){a.sameUrl&&b(a)&&c.send_ping_id&&(clearInterval(c.send_ping_id),c.send_ping_id=null)};this.handle_ready=function(a,e){if((e||a.sameUrl)&&(e||b(a))&&!c.round_started)if(-1==a.count)c.start_fight();else{var d=c.message_board;d.text=0==a.count?
"Fight!":a.count;d.alpha=1;d.visible=!0;var f=d.getBounds();d.x=WLGame.stage_width/2-f.width/2;d.y=WLGame.stage_height/2-f.height/2;createjs.Tween.get(d,{override:!0}).to({alpha:0,visible:!1},500)}};this.handle_sync=function(a){a.sameUrl&&b(a)&&a.id!=c.player.id&&c.sync_event_buffer.push(a)};TogetherJS.hub.on("ping",this.handle_ping);TogetherJS.hub.on("pong",this.handle_pong);TogetherJS.hub.on("ready",this.handle_ready);TogetherJS.hub.on("sync",this.handle_sync);p.call(this,[-3,function(a){return window.TJS.ready?
a:0},function(a){this.send_ping_id=setInterval(function(){TogetherJS.send({type:"ping",id:c.player.id})},3E3);return a},function(a){if(this.enemy_found){console.log("paired with",this.enemy.id);var b=this.enemy.instance;b.alpha=0;b.visible=!0;createjs.Tween.get(b).to({alpha:1},1E3);return a}return 0},function(a){if(this.player.id>this.enemy.id){var b=3,c=this,e=function(){var a={type:"ready",count:b,id:c.player.id};TogetherJS.send(a);c.handle_ready(a,!0);--b;-1<=b&&setTimeout(e,1E3)};setTimeout(e,
1E3)}return a},this.battle_mainloop,function(a){},d.halt])}function q(a){this.assets=a}var A={EPS:1E-6,FPS:60,LOCALSTORAGE_KEY:"WLMSAVE",__dummy__:0},k={key_mapping:{keyboard:{move_left:[KeyEvent.DOM_VK_LEFT],move_right:[KeyEvent.DOM_VK_RIGHT],move_up:[KeyEvent.DOM_VK_UP],move_down:[KeyEvent.DOM_VK_DOWN],action:[KeyEvent.DOM_VK_SHIFT]},gamepad:{move_left:[[0,-0.5],14],move_right:[[0,0.5],15],move_up:[[1,-0.5],12],move_down:[[1,0.5],13],action:[0,2]}}},f={extend:function(){if(0==arguments.length)return{};
for(var a=arguments[0],b=0,e=arguments.length;b<e;++b){var c=arguments[b],d;for(d in c)a[d]=c[d]}return a},range:function(a,b,e){return a<b?b:a>e?e:a},error:function(a){console.error(a);createjs.Ticker.setPaused(!0);throw a;},get_cached_obj:function(a){a=new a;var b=a.nominalBounds;a.cache(b.x,b.y,b.width,b.height);return a},get_bbox_of_dom_obj:function(a){a=a.getBoundingClientRect();var b=WLGame.game_container.getBoundingClientRect();return{x:a.left-b.left,y:a.top-b.top,width:a.width,height:a.height}}};
f.extend(m.prototype,{instance:null,x:0,y:0,vx:0,vy:0,hb_hw:0,hb_hh:0,colliding_mask:0,colliding_group:0,on_stage:function(a){a.addChild(this.instance)},off_stage:function(){var a=this.instance;a.parent&&a.parent.removeChild(a)},recycle:function(){this.pool.put(this)},get_hitbox:function(){return{x:this.x,y:this.y,hw:this.hb_hw,hh:this.hb_hh}},update_physics:function(a){this.x+=this.vx*a;this.y+=this.vy*a},update_graphics:function(){this.instance.x=Math.round(this.x);this.instance.y=Math.round(this.y)}});
f.extend(r.prototype,{put:function(a){this.pool.push(a)},get:function(){return 0<this.pool.length?this.pool.pop():new this.bullet}});f.extend(s.prototype,{gamepad_connected:!0,update:function(a){if(this.gamepad_connected)try{var b=navigator.webkitGetGamepads()[0],e=this;this.gamepad_mapping.forEach(function(a){var c=a.key,d=a.name,f=0;"number"===typeof c?f=b.buttons[c]:(f=c[1],c=b.axes[c[0]],f=0>f&&c<f||0<f&&c>f?1:0);a.count!=f&&(a.count=f,1==f?e.pressed[d]=1:e.released[d]=1,e.input_state[d]=f)})}catch(c){}},
next_frame:function(){for(var a in this.pressed)this.pressed[a]=0;for(a in this.released)this.released[a]=0},is_held:function(a){return 1==this.input_state[a]},is_pressed:function(a){return 1==this.pressed[a]},is_released:function(a){return 1==this.released[a]}});var d={label:1,call:2,goto:3,trap:4,halt:5,msg:6,return:10,restart:11,nop:14,function:16,set_fps:17,call_op:18,invalid:0};f.extend(h.prototype,{init:function(){},on_stage:function(a){},off_stage:function(a){},update:function(a){return a}});
f.extend(t.prototype,new h,{update:function(a){if(a>=this.ms)return a-this.ms;this.ms-=a;return 0}});f.extend(u.prototype,new h,{update:function(a){return WLGame.input.is_released(this.key_name)?a:0}});f.extend(v.prototype,new h);f.extend(w.prototype,new h,{dialog_frame:document.getElementById("game-dialog-frame"),char_interval:64,on_stage:function(a){this.dialog_frame.innerHTML="";this.dialog_frame.style.display="block"},off_stage:function(a){this.dialog_frame.style.display="none"},update:function(a){if(this.msg_idx>=
this.msg_list.length)return a;var b=this.msg_list[this.msg_idx];if(this.char_idx>b.length)return this.char_idx=0,++this.msg_idx,WLGame.director.call_op(new u("action")),a;this.dialog_frame.innerHTML=b.slice(0,this.char_idx);++this.char_idx;if(WLGame.input.is_held("action2"))return 0;WLGame.director.call_op(new t(this.char_interval));return a}});f.extend(p.prototype,new h,{inc_op_idx:!0,on_stage:function(a){this.stage=a},restart:function(){this.op_idx=-1;this.stack=[]},update:function(a){var b=this.next_op();
b&&WLGame.director.call_op(b);return a},next_op:function(){for(;;){this.inc_op_idx?++this.op_idx:this.inc_op_idx=!0;var a=this.script[this.op_idx];if(!a)return f.error("Invalid op_idx: "+this.op_idx),dt;if(a[0]!=d.function&&a[0]!=d.call_op)for(var b=1,e=a.length;b<e;++b)"function"===typeof a[b]&&(a[b]=a[b].call(this));switch(a[0]){case d.label:break;case d.call:this.call_label(a[1]);break;case d.goto:this.goto_label(a[1]);break;case d.trap:f.error("trapped "+this.op_idx);break;case d.halt:return null;
case d.msg:return new w(a.slice(1));case d.return:this.op_idx=this.stack.pop();this.inc_op_idx=!1;break;case d.restart:this.restart();break;case d.nop:break;case d.function:return new v(a[1],this);case d.set_fps:createjs.Ticker.setFPS(a[1]);break;case d.call_op:return new a[1];default:f.error("Unknown op: "+a)}}},call_label:function(a){this.stack.push(this.op_idx+1);this.goto_label(a)},goto_label:function(a){a in this.labels?(this.op_idx=this.labels[a],this.inc_op_idx=!1):f.error("Unknown label: "+
a)},pre_process:function(){for(var a=this.script,b=0,e=a.length;b<e;++b){var c=a[b];"number"==typeof c?a[b]=0>c?[d.label,c]:[c]:"function"==typeof c&&(a[b]=[d.function,c])}this.labels={};b=0;for(e=a.length;b<e;++b)a[b][0]==d.label&&(c=a[b][1],c in this.labels&&f.error("Duplicated labels: "+c),this.labels[c]=b)}});f.extend(x.prototype,{cur_entry_changed:!1,call_op:function(a){this.cur_entry_changed=!0;this.cur_entry={op:a,next:this.cur_entry}},update:function(a){try{for(;;){var b=this.cur_entry;if(!b)return f.error("Director done"),
a;b.on_stage||(b.op.on_stage(this.stage),b.on_stage=!0);a=b.op.update(a);if(0>=a)return a;this.cur_entry_changed?this.cur_entry_changed=!1:(b.op.off_stage(this.stage),this.cur_entry=b.next)}}catch(e){console.log("Director dump:"),console.log(this.cur_entry),console.log(e.stack),f.error("error")}}});f.extend(y.prototype,{on_stage:function(a){a.addChild(this.message_area)},update:function(a){this.message_area.text=this.message}});f.extend(z.prototype,new p,{hp_recover_threshold:3E3,hp_recover_ratio:0.01,
on_stage:function(a){this.stage=a;a.addChild(this.bg_img);a.addChild(this.player.bullet_layer);a.addChild(this.player.instance);a.addChild(this.player_hit_disc);a.addChild(this.enemy.bullet_layer);a.addChild(this.enemy.instance);a.addChild(this.message_board)},off_stage:function(a){a.removeChild(this.bg_img);a.removeChild(this.player.bullet_layer);a.removeChild(this.player.instance);a.removeChild(this.player_hit_disc);a.removeChild(this.enemy.bullet_layer);a.removeChild(this.enemy.instance);a.removeChild(this.message_board)},
start_fight:function(){console.log("Fight started.");this.round_started=!0;this.round_start_time=Date.now();this.last_sync_time=0;var a=this.message_board;a.alpha=0;createjs.Tween.removeTweens(a)},check_player_hit:function(){for(var a=this.player,b=this.enemy.bullet_min_radius,e=this.enemy.bullets,c=!1,d=0,f=e.length;d<f;){var h=e[d],l=h.radius,k=l+this.player.radius,g=a.x-h.x,m=a.y-h.y;g*g+m*m<k*k?(c=l/b,this.player.hp-=c*c,h.off_stage(),h.recycle(),c=!0,e[d]=e[f-1],--e.length,--f):++d}return c},
process_sync_events:function(a){a=this.sync_event_buffer;for(var b=this.enemy,e=0,c=a.length;e<c;++e){var d=a[e];d.sameUrl&&(b.x=WLGame.stage_width-d.x,b.y=WLGame.stage_height-d.y,b.shoot_direction=d.d>Math.PI?d.d-Math.PI:d.d+Math.PI,b.hp=d.hp,this.last_sync_time=Math.max(this.last_sync_time,d.t),d.f&&!b.focused&&b.focus(),!d.f&&b.focused&&b.release())}a.length=0},check_local_input:function(a){var b=this.player;for(b.shoot_direction+=b.shoot_angular_speed*a;b.shoot_direction>2*Math.PI;)b.shoot_direction-=
2*Math.PI;a*=b.focused?b.move_speed_focused:b.move_speed;b.x>a&&WLGame.input.is_held("move_left")?b.x-=a:b.x<WLGame.stage_width-a&&WLGame.input.is_held("move_right")&&(b.x+=a);b.y>a&&WLGame.input.is_held("move_up")?b.y-=a:b.y<WLGame.stage_height-a&&WLGame.input.is_held("move_down")&&(b.y+=a);this.round_started&&WLGame.input.is_pressed("action")&&(b.focus()&&(a=this.player_hit_disc,a.visible=!0,a.alpha=0,createjs.Tween.get(a,{override:!0}).to({alpha:1},1E3)),console.log("press"));this.round_started&&
WLGame.input.is_released("action")&&(b.release()&&(this.player_hit_disc.visible=!1),console.log("release"))},battle_mainloop:function(a){this.process_sync_events(a);this.check_local_input(a);this.player.update(a);this.enemy.update(a);this.player_hit_disc.x=Math.round(this.player.x);this.player_hit_disc.y=Math.round(this.player.y);this.round_started&&(this.player.shoot(a),this.enemy.shoot(a),this.check_player_hit(),this.last_sync_time+this.hp_recover_threshold<Date.now()-this.round_start_time&&(this.player.hp=
Math.min(100,this.player.hp+this.hp_recover_ratio*a)));WLGame.debug_hud.message="FPS: "+Math.round(createjs.Ticker.getMeasuredFPS())+"\nBubbles: "+(this.player.bullets.length+this.player.focused_bullets.length+this.enemy.bullets.length+this.enemy.focused_bullets.length)+"\nHP: "+this.player.hp+"\nHP2: "+this.enemy.hp;TogetherJS.send({type:"sync",x:Math.round(this.player.x),y:Math.round(this.player.y),d:this.player.shoot_direction.toFixed(3),hp:Math.round(this.player.hp),id:this.player.id,f:this.player.focused?
1:0,t:Date.now()-this.round_start_time});return 0}});q.prototype.run=function(){console.log("Game starts.");this.game_container=document.getElementById("game-container");var a=this.stage=new createjs.Stage("game-canvas1");this.stage_width=a.canvas.width;this.stage_height=a.canvas.height;var b=this.input=this.input=new s,d=new createjs.Container;a.addChild(d);var c=this.director=this.director=new x(new z,d),f=this.debug_hud=new y;f.on_stage(a);createjs.Ticker.setFPS(60);createjs.Ticker.addEventListener("tick",
function(d){if(!d.paused){var e=d.delta;b.update(e);c.update(e);f.update(e);a.update(d);b.next_frame()}})};window.Game=q;window.Game.prototype.run=q.prototype.run})();
