(function(){function p(a){this.instance=new createjs.Shape}function v(){this.bullet=function(){p.apply(this,arguments)};f.extend(this.bullet.prototype,p.prototype);this.bullet.prototype.pool=this;this.pool=[]}function w(){var a=this.input_state={};this.new_input_state={};this.pressed={};this.released={};var b=this.keyboard_mapping={},c;for(c in n.key_mapping.keyboard)a[c]=0,n.key_mapping.keyboard[c].forEach(function(a){b[a]={name:c,count:0}});var d=this.gamepad_mapping=[];for(c in n.key_mapping.gamepad)a[c]=
0,n.key_mapping.gamepad[c].forEach(function(a){d.push({key:a,name:c,count:0})});var e=this;document.addEventListener("keydown",function(a){var b=e.keyboard_mapping[a.keyCode];b&&(a.preventDefault(),0==b.count&&(b.count=1,e.pressed[b.name]=1,e.input_state[b.name]=1))});document.addEventListener("keyup",function(a){var b=e.keyboard_mapping[a.keyCode];b&&(a.preventDefault(),1==b.count&&(b.count=0,e.released[b.name]=1,e.input_state[b.name]=0))})}function m(){}function q(a){this.ms=a}function x(a){this.key_name=
a}function y(a,b){this.update=function(c){return a.call(b,c)}}function z(a){this.msg_list=a;this.char_idx=this.msg_idx=0}function r(a){this.script=a?a.slice(0):[];this.script.push(h.halt);this.pre_process();this.restart()}function A(a,b){this.cur_entry={op:a};this.stage=b}function B(){var a=this.message_area=new createjs.Text("FPS: 0");a.x=50;a.y=50;a.color="yellow";a.font="13px Georgia";a.visible=!1;this.message=""}function s(a){f.extend(this,a);this.bullets=[];this.focused_bullets=[];this.bullet_layer=
new createjs.Container;this.bullet_pool=new v;this.update_instance();var b=this;this.instance.addEventListener("animationend",function(a){"release"==a.name&&(b.releasing=!1)})}function t(a){var b=this.player=a.player;this.cached_hp=b.hp;var c=this.instance=new createjs.Shape,d=a.flipped;c.graphics.f(a.color).r(d?-a.width:0,d?0:-a.height,a.width,a.height);c.cache(d?-a.width:0,d?0:-a.height,a.width,a.height);c.x=a.x;c.y=a.y;c.scaleX=b.hp/b.max_hp}function C(){function a(a){if(c.enemy_found)return a.id==
c.enemy.id;if(a.id==c.player.id)return!1;c.enemy_found=!0;c.enemy.id=a.id;return!0}this.player=new s({x:WLGame.stage_width/2,y:0.9*WLGame.stage_height,shoot_direction:0,dir:0,id:Math.random(),instance:new createjs.Sprite(new createjs.SpriteSheet({framerate:12,images:[WLGame.assets.getResult("reimu")],frames:[[115,0,46,96,0,25,44],[0,0,61,96,0,30,44],[0,96,61,96,0,33,44],[61,96,46,112,0,25,60],[107,96,48,99,0,24,47],[61,0,54,96,0,26,44],[155,96,46,96,0,25,44]],animations:{idle:[1],focus:[0],release:[1,
6,"idle"]}}),"idle"),bullet_lightness:25,bullet_alpha:0.45,hp:0});this.enemy=new s({x:WLGame.stage_width/2,y:0.1*WLGame.stage_height,shoot_direction:Math.PI,id:0,instance:new createjs.Sprite(new createjs.SpriteSheet({framerate:12,images:[WLGame.assets.getResult("marisa")],frames:[[172,0,62,101,0,27.95,50],[103,303,90,101,0,29.95,50],[150,202,90,101,0,31.95,50],[154,101,70,101,0,21.95,50],[0,0,172,101,0,26.95,50],[0,101,154,101,0,15.95,50],[0,202,150,101,0,19.95,50],[0,303,103,101,0,18.95,50]],animations:{idle:[0],
focus:[1,2,!1],release:[3,7,"idle"]}}),"idle"),hp:0});this.enemy.instance.visible=!1;this.player.opponent=this.enemy;this.enemy.opponent=this.player;this.player_hp_bar=new t({player:this.player,x:0,y:WLGame.stage_height,width:WLGame.stage_width,height:this.hp_bar_height,color:"red",flipped:!1});this.player_hp_bar.instance.visible=!1;this.enemy_hp_bar=new t({player:this.enemy,x:WLGame.stage_width,y:0,width:WLGame.stage_width,height:this.hp_bar_height,color:"yellow",flipped:!0});this.enemy_hp_bar.instance.visible=
!1;var b=this.player_hit_disc=new createjs.Shape;b.graphics.f("white").dc(0,0,this.player.radius);b.visible=!1;this.bg_img=new createjs.Bitmap(WLGame.assets.getResult("bg"));this.sync_event_buffer=[];this.shoot_timer=this.shoot_interval+1;this.message_board=new createjs.Text;this.message_board.font="100px Georgia";this.message_board.alpha=0;this.message_board.visible=!1;this.message_board.color="white";this.round_started=this.enemy_found=!1;this.round_number=0;var c=this;TogetherJS.hub.on("ping",
function(b){b.sameUrl&&a(b)&&TogetherJS.send({type:"pong",id:c.player.id})});TogetherJS.hub.on("pong",function(b){b.sameUrl&&a(b)&&c.send_ping_id&&(clearTimeout(c.send_ping_id),c.send_ping_id=null)});this.handle_ready=function(b,e){!e&&!b.sameUrl||!e&&!a(b)||b.n!=c.round_number||c.round_started||(c.reset_hp(),-1==b.count?c.start_round():c.show_message(0==b.count?"Fight!":b.count,0,500))};TogetherJS.hub.on("ready",this.handle_ready);TogetherJS.hub.on("sync",function(b){b.sameUrl&&a(b)&&b.id==c.enemy.id&&
c.sync_event_buffer.push(b)});TogetherJS.hub.on("die",function(b){b.sameUrl&&a(b)&&b.id==c.enemy.id&&(c.enemy.dead=!0,c.enemy.dead_time=b.t)});r.call(this,[function(a){return window.TJS.ready?a:0},function(a){function b(){TogetherJS.send({type:"ping",id:c.player.id});c.send_ping_interval+=1E3;c.send_ping_id=setTimeout(b,c.send_ping_interval)}var c=this;this.send_ping_interval=1E3;b();return a},function(a){if(this.enemy_found){console.log("paired with",this.enemy.id);var b=this.enemy.instance;b.alpha=
0;b.visible=!0;createjs.Tween.get(b).to({alpha:1},1E3);return a}return 0},-1,function(a){if(this.player.id>this.enemy.id){var b=3,c=this,k=function(){var a={type:"ready",count:b,n:c.round_number,id:c.player.id};TogetherJS.send(a);c.handle_ready(a,!0);--b;-1<=b&&setTimeout(k,1E3)};setTimeout(k,1E3)}return a},this.battle_mainloop,function(a){console.log("Round ended.",this.round_number);this.show_message(0<this.round_result?"You win!":0>this.round_result?"You lose!":"Tie!",2E3,1E3);this.round_started=
!1;++this.round_number;this.player.focused&&(this.player.release(),this.player_hit_disc.visible=!1);this.enemy.focused&&this.enemy.release();for(var b=0,c=this.player.bullets.length;b<c;++b)this.player.bullets[b].damage=0;b=0;for(c=this.enemy.bullets.length;b<c;++b)this.enemy.bullets[b].damage=0;return a},[h.sleep,1500],[h.goto,-1],h.halt])}function u(a){this.assets=a}var n={key_mapping:{keyboard:{move_left:[KeyEvent.DOM_VK_LEFT],move_right:[KeyEvent.DOM_VK_RIGHT],move_up:[KeyEvent.DOM_VK_UP],move_down:[KeyEvent.DOM_VK_DOWN],
action:[KeyEvent.DOM_VK_SHIFT],debug_hud:[KeyEvent.DOM_VK_F3]},gamepad:{move_left:[[0,-0.5],14],move_right:[[0,0.5],15],move_up:[[1,-0.5],12],move_down:[[1,0.5],13],action:[0,2]}}},f={extend:function(){if(0==arguments.length)return{};for(var a=arguments[0],b=0,c=arguments.length;b<c;++b){var d=arguments[b],e;for(e in d)a[e]=d[e]}return a},error:function(a){console.error(a);createjs.Ticker.setPaused(!0);throw a;}};f.extend(p.prototype,{instance:null,x:0,y:0,vx:0,vy:0,on_stage:function(a){a.addChild(this.instance)},
off_stage:function(){var a=this.instance;a.parent&&a.parent.removeChild(a)},recycle:function(){this.pool.put(this)},update_physics:function(a){this.x+=this.vx*a;this.y+=this.vy*a},update_graphics:function(){this.instance.x=Math.round(this.x);this.instance.y=Math.round(this.y)}});f.extend(v.prototype,{put:function(a){this.pool.push(a)},get:function(){return 0<this.pool.length?this.pool.pop():new this.bullet}});f.extend(w.prototype,{gamepad_connected:!0,update:function(a){if(this.gamepad_connected)try{var b=
navigator.webkitGetGamepads()[0],c=this;this.gamepad_mapping.forEach(function(a){var d=a.key,k=a.name,g=0;"number"===typeof d?g=b.buttons[d]:(g=d[1],d=b.axes[d[0]],g=0>g&&d<g||0<g&&d>g?1:0);a.count!=g&&(a.count=g,1==g?c.pressed[k]=1:c.released[k]=1,c.input_state[k]=g)})}catch(d){}},next_frame:function(){for(var a in this.pressed)this.pressed[a]=0;for(a in this.released)this.released[a]=0},is_held:function(a){return 1==this.input_state[a]},is_pressed:function(a){return 1==this.pressed[a]},is_released:function(a){return 1==
this.released[a]}});var h={label:1,call:2,goto:3,trap:4,halt:5,msg:6,return:10,restart:11,nop:14,function:16,set_fps:17,call_op:18,sleep:19,invalid:0};f.extend(m.prototype,{init:function(){},on_stage:function(a){},off_stage:function(a){},update:function(a){return a}});f.extend(q.prototype,new m,{update:function(a){if(a>=this.ms)return a-this.ms;this.ms-=a;return 0}});f.extend(x.prototype,new m,{update:function(a){return WLGame.input.is_released(this.key_name)?a:0}});f.extend(y.prototype,new m);f.extend(z.prototype,
new m,{dialog_frame:document.getElementById("game-dialog-frame"),char_interval:64,on_stage:function(a){this.dialog_frame.innerHTML="";this.dialog_frame.style.display="block"},off_stage:function(a){this.dialog_frame.style.display="none"},update:function(a){if(this.msg_idx>=this.msg_list.length)return a;var b=this.msg_list[this.msg_idx];if(this.char_idx>b.length)return this.char_idx=0,++this.msg_idx,WLGame.director.call_op(new x("action")),a;this.dialog_frame.innerHTML=b.slice(0,this.char_idx);++this.char_idx;
if(WLGame.input.is_held("action2"))return 0;WLGame.director.call_op(new q(this.char_interval));return a}});f.extend(r.prototype,new m,{inc_op_idx:!0,on_stage:function(a){this.stage=a},restart:function(){this.op_idx=-1;this.stack=[]},update:function(a){var b=this.next_op();b&&WLGame.director.call_op(b);return a},next_op:function(){for(;;){this.inc_op_idx?++this.op_idx:this.inc_op_idx=!0;var a=this.script[this.op_idx];if(!a)return f.error("Invalid op_idx: "+this.op_idx),dt;if(a[0]!=h.function&&a[0]!=
h.call_op)for(var b=1,c=a.length;b<c;++b)"function"===typeof a[b]&&(a[b]=a[b].call(this));switch(a[0]){case h.label:break;case h.call:this.call_label(a[1]);break;case h.goto:this.goto_label(a[1]);break;case h.trap:f.error("trapped "+this.op_idx);break;case h.halt:return null;case h.msg:return new z(a.slice(1));case h.return:this.op_idx=this.stack.pop();this.inc_op_idx=!1;break;case h.restart:this.restart();break;case h.nop:break;case h.function:return new y(a[1],this);case h.set_fps:createjs.Ticker.setFPS(a[1]);
break;case h.call_op:return new a[1];case h.sleep:return new q(a[1]);default:f.error("Unknown op: "+a)}}},call_label:function(a){this.stack.push(this.op_idx+1);this.goto_label(a)},goto_label:function(a){a in this.labels?(this.op_idx=this.labels[a],this.inc_op_idx=!1):f.error("Unknown label: "+a)},pre_process:function(){for(var a=this.script,b=0,c=a.length;b<c;++b){var d=a[b];"number"==typeof d?a[b]=0>d?[h.label,d]:[d]:"function"==typeof d&&(a[b]=[h.function,d])}this.labels={};b=0;for(c=a.length;b<
c;++b)a[b][0]==h.label&&(d=a[b][1],d in this.labels&&f.error("Duplicated labels: "+d),this.labels[d]=b)}});f.extend(A.prototype,{cur_entry_changed:!1,call_op:function(a){this.cur_entry_changed=!0;this.cur_entry={op:a,next:this.cur_entry}},update:function(a){try{for(;;){var b=this.cur_entry;if(!b)return f.error("Director done"),a;b.on_stage||(b.op.on_stage(this.stage),b.on_stage=!0);a=b.op.update(a);if(0>=a)return a;this.cur_entry_changed?this.cur_entry_changed=!1:(b.op.off_stage(this.stage),this.cur_entry=
b.next)}}catch(c){console.log("Director dump:"),console.log(this.cur_entry),console.log(c.stack),f.error("error")}}});f.extend(B.prototype,{on_stage:function(a){a.addChild(this.message_area)},update:function(a){this.message_area.text=this.message},toggle:function(){this.message_area.visible=!this.message_area.visible}});s.prototype={shoot_interval:50,shoot_angular_speed:Math.PI/1E3,shoot_count:3,shoot_timer:0,shoot_direction:0,move_speed:0.2,move_speed_focused:0.06,bullet_speed:0.128,bullet_min_radius:5,
bullet_max_radius:20,bullet_lightness:50,bullet_alpha:0.9,focused_shoot_interval:100,focused_bullet_radius:5,focused_bullet_angular_speed:Math.PI/1E3,focused_bullet_release_speed:0.5,focused_bullet_count_limit:30,focused_bullet_damage:5,focused_circle_radius:7,radius:5,stage_margin:100,hp:100,max_hp:100,focused:!1,releasing:!1,dead:!1,update_bullets:function(a){for(var b=this.stage_margin,c=WLGame.stage_width,d=WLGame.stage_height,e=this.bullets,l=0,k=e.length;l<k;){var g=e[l];g.update_physics(a);
g.update_graphics();g.x<-b||g.x>c+b||g.y<-b||g.y>d+b?(g.off_stage(),g.recycle(),e[l]=e[k-1],--e.length,--k):++l}b=this.focused_bullets;c=this.focused_bullet_angular_speed;d=this.focused_circle_radius;l=0;for(k=b.length;l<k;++l)g=b[l],g.life_time+=a,g.revolution_angle-=c*a,e=Math.log(1+g.life_time)*d,g.x=this.x+e*Math.cos(g.revolution_angle),g.y=this.y+e*Math.sin(g.revolution_angle),g.update_graphics()},focus:function(){this.focused=!0;this.instance.gotoAndPlay("focus")},release:function(){this.focused=
!1;this.releasing=!0;this.instance.gotoAndPlay("release");for(var a=this.focused_bullets,b=this.opponent.x,c=this.opponent.y,d=0,e=a.length;d<e;++d){var l=a[d],k=b-l.x,g=c-l.y,f=Math.sqrt(k*k+g*g),h=this.focused_bullet_release_speed*(1+Math.random());1E-6>Math.abs(f)?(k=Math.random()*Math.PI*2,l.vx=h*Math.cos(k),l.vy=h*Math.sin(k)):(l.vx=h*k/f,l.vy=h*g/f);this.bullets.push(l)}a.length=0},shoot:function(a){this.shoot_timer+=a;if(this.focused)for(;this.shoot_timer>this.focused_shoot_interval;){if(this.focused_bullets.length>=
this.focused_bullet_count_limit){this.shoot_timer=0;break}this.shoot_timer-=this.focused_shoot_interval;var b=this.focused_bullet_radius;Date.now();a=this.shoot_direction;for(var c=0;c<this.shoot_count;++c){var d=this.bullet_pool.get();f.extend(d,{x:this.x,y:this.y,life_time:0,radius:b,damage:this.focused_bullet_damage,revolution_angle:a});d.instance.graphics.c().f(createjs.Graphics.getRGB(0,255,255,0.2)).de(-2*b-1,-b-1,4*b+2,2*b+2).f("cyan").de(-2*b,-b,4*b,2*b).f("white").de(-2*b+1,-b+1,4*b-2,2*
b-2);d.instance.cache(-2*b-1,-b-1,4*b+2,2*b+2);d.instance.rotation=360*Math.random();d.instance.alpha=0.5*Math.random()+0.5;d.on_stage(this.bullet_layer);this.focused_bullets.push(d);a+=2*Math.PI/this.shoot_count}}else for(;this.shoot_timer>this.shoot_interval;)for(this.shoot_timer-=this.shoot_interval,a=this.shoot_direction,c=0;c<this.shoot_count;++c){d=this.bullet_pool.get();b=this.bullet_min_radius+Math.random()*(this.bullet_max_radius-this.bullet_min_radius);d.instance.graphics.c().ss(2).s("white").f(createjs.Graphics.getHSL(Date.now()%
2E3/2E3*360,100,this.bullet_lightness)).dc(0,0,b-1);d.instance.cache(-b-1,-b-1,2*b+2,2*b+2);d.instance.alpha=this.bullet_alpha;Math.sqrt(2);var e=this.bullet_speed*(1+(1+Math.cos(Date.now()%2E3))/2);f.extend(d,{x:this.x,y:this.y,vx:e*Math.cos(a),vy:e*Math.sin(a),damage:b*b/this.bullet_min_radius/this.bullet_min_radius,radius:b});d.on_stage(this.bullet_layer);this.bullets.push(d);a+=2*Math.PI/this.shoot_count}},update_instance:function(a){this.instance.x=Math.round(this.x);this.instance.y=Math.round(this.y)},
update:function(a){this.update_bullets(a);this.update_instance(a)}};f.extend(t.prototype,{animation_duration:500,update:function(a){a=this.player;a.hp!=this.cached_hp&&(this.cached_hp=a.hp,createjs.Tween.get(this.instance,{override:!0}).to({scaleX:a.hp/a.max_hp},this.animation_duration))}});f.extend(C.prototype,new r,{hp_bar_height:4,on_stage:function(a){this.stage=a;a.addChild(this.bg_img);a.addChild(this.player.bullet_layer);a.addChild(this.player.instance);a.addChild(this.player_hit_disc);a.addChild(this.enemy.bullet_layer);
a.addChild(this.enemy.instance);a.addChild(this.player_hp_bar.instance);a.addChild(this.enemy_hp_bar.instance);a.addChild(this.message_board)},off_stage:function(a){a.removeChild(this.bg_img);a.removeChild(this.player.bullet_layer);a.removeChild(this.player.instance);a.removeChild(this.player_hit_disc);a.removeChild(this.enemy.bullet_layer);a.removeChild(this.enemy.instance);a.removeChild(this.player_hp_bar.instance);a.removeChild(this.enemy_hp_bar.instance);a.removeChild(this.message_board)},start_round:function(){console.log("Round started.",
this.round_number);this.round_started=!0;this.round_start_time=Date.now();this.last_sync_time=0;var a=this.message_board;a.alpha=0;a.visible=!1;createjs.Tween.removeTweens(a)},check_player_hit:function(){for(var a=this.player,b=this.enemy.bullets,c=!1,d=0,e=b.length;d<e;){var l=b[d];if(0==l.damage)++d;else{var k=l.radius+this.player.radius,g=a.x-l.x,f=a.y-l.y;g*g+f*f<k*k?(this.player.hp-=l.damage,l.off_stage(),l.recycle(),c=!0,b[d]=b[e-1],--b.length,--e):++d}}return c},process_sync_events:function(a){a=
this.sync_event_buffer;for(var b=this.enemy,c=0,d=a.length;c<d;++c){var e=a[c];e.n==this.round_number&&(b.x=WLGame.stage_width-e.x,b.y=WLGame.stage_height-e.y,b.shoot_direction=e.d>Math.PI?e.d-Math.PI:e.d+Math.PI,b.hp=e.hp,this.last_sync_time=Math.max(this.last_sync_time,e.t),e.f&&!b.focused?b.focus():!e.f&&b.focused&&b.release())}a.length=0},check_local_input:function(a){var b=this.player;for(b.shoot_direction+=b.shoot_angular_speed*a;b.shoot_direction>2*Math.PI;)b.shoot_direction-=2*Math.PI;a*=
b.focused||b.releasing?b.move_speed_focused:b.move_speed;b.x>a&&WLGame.input.is_held("move_left")?b.x-=a:b.x<WLGame.stage_width-a&&WLGame.input.is_held("move_right")&&(b.x+=a);b.y>a&&WLGame.input.is_held("move_up")?b.y-=a:b.y<WLGame.stage_height-a&&WLGame.input.is_held("move_down")&&(b.y+=a);this.round_started&&(WLGame.input.is_held("action")?b.focused||b.releasing||(b.focus(),b=this.player_hit_disc,b.visible=!0,b.alpha=0,createjs.Tween.get(b,{override:!0}).to({alpha:1},1E3)):b.focused&&(b.release(),
this.player_hit_disc.visible=!1))},show_message:function(a,b,c){var d=this.message_board;d.text=a;d.alpha=1;d.visible=!0;a=d.getBounds();d.x=WLGame.stage_width/2-a.width/2;d.y=WLGame.stage_height/2-a.height/2;createjs.Tween.get(d,{override:!0}).wait(b).to({alpha:0,visible:!1},c)},reset_hp:function(){this.player.dead=!1;this.player.hp=this.player.max_hp;this.enemy.dead=!1;this.enemy.hp=this.enemy.max_hp;this.player_hp_bar.instance.visible=!0;this.player_hp_bar.update();this.enemy_hp_bar.instance.visible=
!0;this.enemy_hp_bar.update()},battle_mainloop:function(a){var b=0,c=!1;this.process_sync_events(a);this.check_local_input(a);this.player.update(a);this.enemy.update(a);this.player_hit_disc.x=Math.round(this.player.x);this.player_hit_disc.y=Math.round(this.player.y);this.round_started&&(b=Date.now()-this.round_start_time,this.player.shoot(a),this.enemy.shoot(a),this.check_player_hit(),this.player_hp_bar.update(a),this.enemy_hp_bar.update(a),0>=this.player.hp&&!this.player.dead&&(this.player.dead=
!0,this.player.dead_time=b,TogetherJS.send({type:"die",id:this.player.id,n:this.round_number,t:b})),this.enemy.dead?this.player.dead?(a=this.player.dead_time-this.enemy.dead_time,1E-6>Math.abs(a)?this.round_result=0:this.round_result=0<a?1:-1,c=!0):b>this.enemy.dead_time&&(this.round_result=1,c=!0):this.player.dead&&this.last_sync_time>this.player.dead_time&&(this.round_result=-1,c=!0));var d=this.player.bullets.length,e=this.player.focused_bullets.length,f=this.enemy.bullets.length,k=this.enemy.focused_bullets.length;
WLGame.debug_hud.message="FPS: "+Math.round(createjs.Ticker.getMeasuredFPS())+"\nBubbles: "+(d+e+f+k)+" ("+d+" "+e+" "+f+" "+k+")\nHP: "+this.player.hp.toFixed(2)+"\nHP2: "+this.enemy.hp.toFixed(2);TogetherJS.send({type:"sync",x:Math.round(this.player.x),y:Math.round(this.player.y),d:Math.round(1E3*this.player.shoot_direction)/1E3,hp:Math.round(this.player.hp),id:this.player.id,f:this.player.focused?1:0,n:this.round_number,t:b});return c?a:0}});u.prototype.run=function(){console.log("Game starts.");
this.game_container=document.getElementById("game-container");var a=this.stage=new createjs.Stage("game-canvas1");this.stage_width=a.canvas.width;this.stage_height=a.canvas.height;var b=this.input=this.input=new w,c=new createjs.Container;a.addChild(c);var d=this.director=this.director=new A(new C,c),e=this.debug_hud=new B;e.on_stage(a);createjs.Ticker.setFPS(60);createjs.Ticker.addEventListener("tick",function(c){if(!c.paused){var f=c.delta;b.update(f);d.update(f);b.is_pressed("debug_hud")&&e.toggle();
e.update(f);a.update(c);b.next_frame()}})};window.Game=u;window.Game.prototype.run=u.prototype.run})();
