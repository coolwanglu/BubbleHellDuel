(function(){function k(a){this.instance=new createjs.Shape}function q(){this.bullet=function(){k.apply(this,arguments)};f.extend(this.bullet.prototype,k.prototype);this.bullet.prototype.pool=this;this.pool=[]}function r(){var a=this.input_state={};this.new_input_state={};this.pressed={};this.released={};var b=this.keyboard_mapping={},e;for(e in h.key_mapping.keyboard)a[e]=0,h.key_mapping.keyboard[e].forEach(function(a){b[a]={name:e,count:0}});var d=this.gamepad_mapping=[];for(e in h.key_mapping.gamepad)a[e]=
0,h.key_mapping.gamepad[e].forEach(function(a){d.push({key:a,name:e,count:0})});var l=this;document.getElementById("game-container").addEventListener("keydown",function(a){var b=l.keyboard_mapping[a.keyCode];b&&(a.preventDefault(),0==b.count&&(b.count=1,l.pressed[b.name]=1,l.input_state[b.name]=1))});document.getElementById("game-container").addEventListener("keyup",function(a){var b=l.keyboard_mapping[a.keyCode];b&&(a.preventDefault(),1==b.count&&(b.count=0,l.released[b.name]=1,l.input_state[b.name]=
0))})}function g(){}function s(a){this.ms=a}function t(a){this.key_name=a}function u(a,b){this.update=function(e){return a.call(b,e)}}function v(a){this.msg_list=a;this.char_idx=this.msg_idx=0}function m(a){this.script=a?a.slice(0):[];this.script.push(c.halt);this.pre_process();this.restart()}function w(a,b){this.cur_entry={op:a};this.stage=b}function x(){var a=this.message_area=new createjs.Text("FPS: 0");a.x=50;a.y=50;a.color="yellow";a.font="13px Georgia";this.message=""}function y(){function a(a){f.extend(this,
a);this.bullets=[];this.bullets2=[];this.bullet_layer=new createjs.Container;this.bullet_pool=new q;this.update_instance()}function b(){d.enemy.instance.gotoAndPlay("hold");d.player.instance.gotoAndPlay("hold");setTimeout(function(){d.enemy.instance.gotoAndPlay("release");d.player.instance.gotoAndPlay("release");setTimeout(b,2E3)},1E3)}function e(a){if(d.enemy_found)return a.id==d.enemy.id;if(a.id==d.player.id)return!1;d.enemy_found=!0;d.enemy.id=a.id;return!0}a.prototype={shoot_interval:50,shoot_angular_speed:Math.PI/
1E3,shoot_count:3,shoot_timer:0,shoot_direction:0,move_speed:0.2,bullet_speed:0.128,bullet_min_radius:5,bullet_max_radius:20,bullet_lightness:50,bullet_alpha:0.9,radius:5,stage_margin:100,hp:100,update_bullets:function(a){var b=this.bullets2;b.length=0;for(var e=this.stage_margin,d=0,f=this.bullets.length;d<f;++d){var c=this.bullets[d];c.update_physics(a);c.update_graphics();c.x<-e||c.x>WLGame.stage.canvas.width+e||c.y<-e||c.y>WLGame.stage.canvas.height+e?(c.off_stage(),c.recycle()):b.push(c)}this.bullets2=
this.bullets;this.bullets=b},shoot:function(a){for(this.shoot_timer+=a;this.shoot_timer>this.shoot_interval;){this.shoot_timer-=this.shoot_interval;a=this.shoot_direction;for(var b=0;b<this.shoot_count;++b){var e=this.bullet_pool.get(),d=this.bullet_min_radius+Math.random()*(this.bullet_max_radius-this.bullet_min_radius);e.instance.graphics.c().ss(2).s("white").f(createjs.Graphics.getHSL(Date.now()%2E3/2E3*360,100,this.bullet_lightness)).dc(0,0,d-1);e.instance.cache(-d-1,-d-1,2*d+2,2*d+2);e.instance.alpha=
this.bullet_alpha;Math.sqrt(2);var c=this.bullet_speed*(1+(1+Math.cos(Date.now()%2E3))/2);f.extend(e,{x:this.x,y:this.y,vx:c*Math.cos(a),vy:c*Math.sin(a),radius:d});e.on_stage(this.bullet_layer);this.bullets.push(e);a+=2*Math.PI/this.shoot_count}}},update_instance:function(a){this.instance.x=Math.round(this.x);this.instance.y=Math.round(this.y)},update:function(a){this.update_bullets(a);this.update_instance(a)}};this.player=new a({x:WLGame.stage_width/2,y:0.9*WLGame.stage_height,shoot_direction:0,
dir:0,id:Math.random(),instance:new createjs.Sprite(new createjs.SpriteSheet({framerate:12,images:[WLGame.assets.getResult("reimu")],frames:[[115,0,46,96,0,25,44],[0,0,61,96,0,30,44],[0,96,61,96,0,33,44],[61,96,46,112,0,25,60],[107,96,48,99,0,24,47],[61,0,54,96,0,26,44],[155,96,46,96,0,25,44]],animations:{idle:[1],hold:[0],release:[1,6,"idle"]}}),"idle"),bullet_lightness:25,bullet_alpha:0.45});this.enemy=new a({x:WLGame.stage_width/2,y:0.1*WLGame.stage_height,shoot_direction:Math.PI,id:0,instance:new createjs.Sprite(new createjs.SpriteSheet({framerate:12,
images:[WLGame.assets.getResult("marisa")],frames:[[172,0,62,101,0,27.95,50],[103,303,90,101,0,29.95,50],[150,202,90,101,0,31.95,50],[154,101,70,101,0,21.95,50],[0,0,172,101,0,26.95,50],[0,101,154,101,0,15.95,50],[0,202,150,101,0,19.95,50],[0,303,103,101,0,18.95,50]],animations:{idle:[0],hold:[1,2,!1],release:[3,7,"idle"]}}),"idle")});this.enemy.instance.visible=!1;this.enemy.instance.visible=!0;var d=this;b();this.bg_img=new createjs.Bitmap(WLGame.assets.getResult("bg"));this.sync_event_buffer=[];
this.shoot_timer=this.shoot_interval+1;this.ready_text=new createjs.Text;this.ready_text.font="100px Georgia";this.ready_text.alpha=0;this.ready_text.visible=!1;this.ready_text.color="white";this.game_started=this.enemy_found=!1;d=this;this.handle_ping=function(a){a.sameUrl&&e(a)&&TogetherJS.send({type:"pong",id:d.player.id})};this.handle_pong=function(a){a.sameUrl&&e(a)&&d.send_ping_id&&(clearInterval(d.send_ping_id),d.send_ping_id=null)};this.handle_ready=function(a,b){if((b||a.sameUrl)&&(b||e(a))&&
!d.game_started)if(console.log(a),-1==a.count)d.start_fight();else{var c=d.ready_text;c.text=0==a.count?"Fight!":a.count;c.alpha=1;c.visible=!0;var f=c.getBounds();c.x=WLGame.stage_width/2-f.width/2;c.y=WLGame.stage_height/2-f.height/2;createjs.Tween.get(c,{override:!0}).to({alpha:0,visible:!1},500)}};this.handle_sync=function(a){a.sameUrl&&e(a)&&a.id!=d.player.id&&d.sync_event_buffer.push(a)};TogetherJS.hub.on("ping",this.handle_ping);TogetherJS.hub.on("pong",this.handle_pong);TogetherJS.hub.on("ready",
this.handle_ready);TogetherJS.hub.on("sync",this.handle_sync);m.call(this,[-3,function(a){return window.TJS.ready?a:0},function(a){this.send_ping_id=setInterval(function(){TogetherJS.send({type:"ping",id:d.player.id})},3E3);return a},function(a){if(this.enemy_found){console.log("paired with",this.enemy.id);var b=this.enemy.instance;b.alpha=0;b.visible=!0;createjs.Tween.get(b).to({alpha:1},1E3);return a}return 0},function(a){if(this.player.id>this.enemy.id){var b=3,e=this,d=function(){var a={type:"ready",
count:b,id:e.player.id};TogetherJS.send(a);e.handle_ready(a,!0);--b;-1<=b&&setTimeout(d,1E3)};setTimeout(d,1E3)}return a},this.battle_mainloop,function(a){},c.halt])}function p(a){this.assets=a}var h={key_mapping:{keyboard:{move_left:[KeyEvent.DOM_VK_LEFT],move_right:[KeyEvent.DOM_VK_RIGHT],move_up:[KeyEvent.DOM_VK_UP],move_down:[KeyEvent.DOM_VK_DOWN],action:[KeyEvent.DOM_VK_SHIFT]},gamepad:{move_left:[[0,-0.5],14],move_right:[[0,0.5],15],move_up:[[1,-0.5],12],move_down:[[1,0.5],13],action:[0]}}},
f={extend:function(){if(0==arguments.length)return{};for(var a=arguments[0],b=0,e=arguments.length;b<e;++b){var d=arguments[b],c;for(c in d)a[c]=d[c]}return a},range:function(a,b,e){return a<b?b:a>e?e:a},error:function(a){console.error(a);createjs.Ticker.setPaused(!0);throw a;},get_cached_obj:function(a){a=new a;var b=a.nominalBounds;a.cache(b.x,b.y,b.width,b.height);return a},get_bbox_of_dom_obj:function(a){a=a.getBoundingClientRect();var b=WLGame.game_container.getBoundingClientRect();return{x:a.left-
b.left,y:a.top-b.top,width:a.width,height:a.height}}};f.extend(k.prototype,{instance:null,x:0,y:0,vx:0,vy:0,hb_hw:0,hb_hh:0,colliding_mask:0,colliding_group:0,on_stage:function(a){a.addChild(this.instance)},off_stage:function(){var a=this.instance;a.parent&&a.parent.removeChild(a)},recycle:function(){this.pool.put(this)},get_hitbox:function(){return{x:this.x,y:this.y,hw:this.hb_hw,hh:this.hb_hh}},update_physics:function(a){this.x+=this.vx*a;this.y+=this.vy*a},update_graphics:function(){this.instance.x=
Math.round(this.x);this.instance.y=Math.round(this.y)}});f.extend(q.prototype,{put:function(a){this.pool.push(a)},get:function(){return 0<this.pool.length?this.pool.pop():new this.bullet}});f.extend(r.prototype,{gamepad_connected:!0,update:function(a){if(this.gamepad_connected)try{var b=navigator.webkitGetGamepads()[0],e=this;this.gamepad_mapping.forEach(function(a){var d=a.key,c=a.name,f=0;"number"===typeof d?f=b.buttons[d]:(f=d[1],d=b.axes[d[0]],f=0>f&&d<f||0<f&&d>f?1:0);a.count!=f&&(a.count=f,
1==f?e.pressed[c]=1:e.released[c]=1,e.input_state[c]=f)})}catch(d){}},next_frame:function(){for(var a in this.pressed)this.pressed[a]=0;for(a in this.released)this.released[a]=0},is_held:function(a){return 1==this.input_state[a]},is_pressed:function(a){return 1==this.pressed[a]},is_released:function(a){return 1==this.released[a]}});var c={label:1,call:2,goto:3,trap:4,halt:5,msg:6,return:10,restart:11,nop:14,function:16,set_fps:17,call_op:18,invalid:0};f.extend(g.prototype,{init:function(){},on_stage:function(a){},
off_stage:function(a){},update:function(a){return a}});f.extend(s.prototype,new g,{update:function(a){if(a>=this.ms)return a-this.ms;this.ms-=a;return 0}});f.extend(t.prototype,new g,{update:function(a){return WLGame.input.is_released(this.key_name)?a:0}});f.extend(u.prototype,new g);f.extend(v.prototype,new g,{dialog_frame:document.getElementById("game-dialog-frame"),char_interval:64,on_stage:function(a){this.dialog_frame.innerHTML="";this.dialog_frame.style.display="block"},off_stage:function(a){this.dialog_frame.style.display=
"none"},update:function(a){if(this.msg_idx>=this.msg_list.length)return a;var b=this.msg_list[this.msg_idx];if(this.char_idx>b.length)return this.char_idx=0,++this.msg_idx,WLGame.director.call_op(new t("action")),a;this.dialog_frame.innerHTML=b.slice(0,this.char_idx);++this.char_idx;if(WLGame.input.is_held("action2"))return 0;WLGame.director.call_op(new s(this.char_interval));return a}});f.extend(m.prototype,new g,{inc_op_idx:!0,on_stage:function(a){this.stage=a},restart:function(){this.op_idx=-1;
this.stack=[]},update:function(a){var b=this.next_op();b&&WLGame.director.call_op(b);return a},next_op:function(){for(;;){this.inc_op_idx?++this.op_idx:this.inc_op_idx=!0;var a=this.script[this.op_idx];if(!a)return f.error("Invalid op_idx: "+this.op_idx),dt;if(a[0]!=c.function&&a[0]!=c.call_op)for(var b=1,e=a.length;b<e;++b)"function"===typeof a[b]&&(a[b]=a[b].call(this));switch(a[0]){case c.label:break;case c.call:this.call_label(a[1]);break;case c.goto:this.goto_label(a[1]);break;case c.trap:f.error("trapped "+
this.op_idx);break;case c.halt:return null;case c.msg:return new v(a.slice(1));case c.return:this.op_idx=this.stack.pop();this.inc_op_idx=!1;break;case c.restart:this.restart();break;case c.nop:break;case c.function:return new u(a[1],this);case c.set_fps:createjs.Ticker.setFPS(a[1]);break;case c.call_op:return new a[1];default:f.error("Unknown op: "+a)}}},call_label:function(a){this.stack.push(this.op_idx+1);this.goto_label(a)},goto_label:function(a){a in this.labels?(this.op_idx=this.labels[a],this.inc_op_idx=
!1):f.error("Unknown label: "+a)},pre_process:function(){for(var a=this.script,b=0,e=a.length;b<e;++b){var d=a[b];"number"==typeof d?a[b]=0>d?[c.label,d]:[d]:"function"==typeof d&&(a[b]=[c.function,d])}this.labels={};b=0;for(e=a.length;b<e;++b)a[b][0]==c.label&&(d=a[b][1],d in this.labels&&f.error("Duplicated labels: "+d),this.labels[d]=b)}});f.extend(w.prototype,{cur_entry_changed:!1,call_op:function(a){this.cur_entry_changed=!0;this.cur_entry={op:a,next:this.cur_entry}},update:function(a){try{for(;;){var b=
this.cur_entry;if(!b)return f.error("Director done"),a;b.on_stage||(b.op.on_stage(this.stage),b.on_stage=!0);a=b.op.update(a);if(0>=a)return a;this.cur_entry_changed?this.cur_entry_changed=!1:(b.op.off_stage(this.stage),this.cur_entry=b.next)}}catch(e){console.log("Director dump:"),console.log(this.cur_entry),console.log(e.stack),f.error("error")}}});f.extend(x.prototype,{on_stage:function(a){a.addChild(this.message_area)},update:function(a){this.message_area.text=this.message}});f.extend(y.prototype,
new m,{hp_recover_threshold:3E3,hp_recover_ratio:0.01,on_stage:function(a){this.stage=a;a.addChild(this.bg_img);a.addChild(this.player.bullet_layer);a.addChild(this.enemy.bullet_layer);a.addChild(this.enemy.instance);a.addChild(this.player.instance);a.addChild(this.ready_text)},off_stage:function(a){a.removeChild(this.bg_img);a.removeChild(this.bullet_layer);a.removeChild(this.enemy.bullet_layer);a.removeChild(this.enemy.instance);a.removeChild(this.player.instance);a.removeChild(this.ready_text)},
start_fight:function(){console.log("Fight started.");this.game_started=!0;this.round_start_time=Date.now();this.last_sync_time=0;var a=this.ready_text;a.alpha=0;createjs.Tween.removeTweens(a);var b=this,e=function(){b.enemy.instance.gotoAndPlay("attack");b.game_started&&setTimeout(e,1E3+1E3*Math.random())};e()},check_player_hit:function(){var a=this.player,b=this.enemy.bullet_min_radius,e=this.enemy.bullets,d=this.enemy.bullets2;d.length=0;for(var c=!1,f=0,g=e.length;f<g;++f){var n=e[f],h=n.radius,
k=h+this.player.radius,m=a.x-n.x,p=a.y-n.y;m*m+p*p<k*k?(c=h/b,this.player.hp-=c*c,n.off_stage(),n.recycle(),c=!0):d.push(n)}this.enemy.bullets=d;this.enemy.bullets2=e;return c},process_sync_events:function(a){a=this.sync_event_buffer;for(var b=this.enemy,e=0,d=a.length;e<d;++e){var c=a[e];c.sameUrl&&(b.x=WLGame.stage_width-c.x,b.y=WLGame.stage_height-c.y,b.shoot_direction=c.d>Math.PI?c.d-Math.PI:c.d+Math.PI,b.hp=c.hp,this.last_sync_time=Math.max(this.last_sync_time,c.t))}b.length=0},check_local_input:function(a){var b=
this.player;for(b.shoot_direction+=b.shoot_angular_speed*a;b.shoot_direction>2*Math.PI;)b.shoot_direction-=2*Math.PI;a*=b.move_speed;b.x>a&&WLGame.input.is_held("move_left")?b.x-=a:b.x<WLGame.stage_width-a&&WLGame.input.is_held("move_right")&&(b.x+=a);b.y>a&&WLGame.input.is_held("move_up")?b.y-=a:b.y<WLGame.stage_height-a&&WLGame.input.is_held("move_down")&&(b.y+=a)},battle_mainloop:function(a){this.process_sync_events(a);this.check_local_input(a);this.player.update(a);this.enemy.update(a);this.game_started&&
(this.player.shoot(a),this.enemy.shoot(a),this.check_player_hit(),this.last_sync_time+this.hp_recover_threshold<Date.now()-this.round_start_time&&(this.player.hp=Math.min(100,this.player.hp+this.hp_recover_ratio*a)));WLGame.debug_hud.message="FPS: "+Math.round(createjs.Ticker.getMeasuredFPS())+"\nBubbles: "+(this.player.bullets.length+this.enemy.bullets.length)+"\nHP: "+this.player.hp+"\nHP2: "+this.enemy.hp;TogetherJS.send({type:"sync",x:Math.round(this.player.x),y:Math.round(this.player.y),d:this.player.shoot_direction,
hp:Math.round(this.player.hp),id:this.player.id,t:Date.now()-this.round_start_time});return 0}});p.prototype.run=function(){console.log("Game starts.");this.game_container=document.getElementById("game-container");var a=this.stage=new createjs.Stage("game-canvas1");this.stage_width=a.canvas.width;this.stage_height=a.canvas.height;var b=this.input=this.input=new r,c=new createjs.Container;a.addChild(c);var d=this.director=this.director=new w(new y,c),f=this.debug_hud=new x;f.on_stage(a);createjs.Ticker.setFPS(60);
createjs.Ticker.addEventListener("tick",function(c){if(!c.paused){var e=c.delta;b.update(e);d.update(e);f.update(e);a.update(c);b.next_frame()}})};window.Game=p;window.Game.prototype.run=p.prototype.run})();
